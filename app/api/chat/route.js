import { NextResponse } from 'next/server';

// ูุงุนุฏุฉ ูุนุฑููุฉ ุจุณูุทุฉ ูููุณุงุนุฏ ุงูุฐูู
const knowledgeBase = {
  // ุฃุณุฆูุฉ ุญูู ุงููููุน
  'ูุง ูู|ูุงูู|ุงูุด ูู|ุดูู ูู': 'ุณูู ุงูููู ูู ุฃูุจุฑ ููุตุฉ ููุฅุนูุงูุงุช ูุงููุฒุงุฏุงุช ูู ุงูููู. ููุฏู ุฎุฏูุฉ ุจูุน ูุดุฑุงุก ุงูุณูุงุฑุงุชุ ุงูุนูุงุฑุงุชุ ุงูุฌูุงูุงุชุ ุงูุฅููุชุฑูููุงุชุ ูุงููุฒูุฏ. ููููู ุชุตูุญ ุฃูุซุฑ ูู 16 ูุฆุฉ ูุฎุชููุฉ.',
  
  // ููููุฉ ุฅุถุงูุฉ ุฅุนูุงู
  'ููู ุงุถูู|ููู ุงูุดุฑ|ููู ุงุนูู|ุงุถุงูุฉ ุงุนูุงู|ูุดุฑ ุงุนูุงู': 'ูุฅุถุงูุฉ ุฅุนูุงูุ ุงุชุจุน ูุฐู ุงูุฎุทูุงุช:\n1. ุณุฌู ุฏุฎูู ุฃู ุฃูุดุฆ ุญุณุงุจ ุฌุฏูุฏ\n2. ุงุถุบุท ุนูู ุฒุฑ "ุฅุถุงูุฉ ุฅุนูุงู" ูู ุงููุงุฆูุฉ\n3. ุงุฎุชุฑ ุงููุฆุฉ ุงูููุงุณุจุฉ\n4. ุงููุฃ ุชูุงุตูู ุงูุฅุนูุงู ูุฃุถู ุงูุตูุฑ\n5. ุงุถุบุท ูุดุฑ\n\nููููู ุงูุงูุชูุงู ูุจุงุดุฑุฉ ูุตูุญุฉ ุงูุฅุถุงูุฉ ูู ููุง: /add',
  
  // ุงููุฆุงุช ุงููุชุงุญุฉ
  'ูุฆุงุช|ุงูุณุงู|ุชุตูููุงุช|categories': 'ุงููุฆุงุช ุงููุชููุฑุฉ ูู ุณูู ุงูููู:\n๐ ุณูุงุฑุงุช\n๐ ุนูุงุฑุงุช\n๐ฑ ุฌูุงูุงุช\n๐ป ุฅููุชุฑูููุงุช\n๐๏ธ ุฏุฑุงุฌุงุช ูุงุฑูุฉ\n๐ ูุนุฏุงุช ุซูููุฉ\nโ๏ธ ุทุงูุฉ ุดูุณูุฉ\n๐ ุดุจูุงุช\n๐ง ุตูุงูุฉ\n๐๏ธ ุฃุซุงุซ\n๐ก ุฃุฏูุงุช ููุฒููุฉ\n๐ ููุงุจุณ\n๐พ ุญููุงูุงุช\n๐ผ ูุธุงุฆู\nโ๏ธ ุฎุฏูุงุช\n๐ฆ ุฃุฎุฑู',
  
  // ุงููุญุงุฏุซุงุช
  'ูุญุงุฏุซุฉ|ุดุงุช|ุชูุงุตู ูุน ุงูุจุงุฆุน': 'ููููู ุงูุชูุงุตู ูุน ุงูุจุงุฆุน ูุจุงุดุฑุฉ ูู ุฎูุงู:\n1. ุงูุชุญ ุตูุญุฉ ุงูุฅุนูุงู\n2. ุงุถุบุท ุนูู ุฒุฑ "๐ฌ ูุญุงุฏุซุฉ"\n3. ุงุจุฏุฃ ุงููุญุงุฏุซุฉ ูุน ุงูุจุงุฆุน\n\nููููู ุฃูุถุงู ูุฑุงุฌุนุฉ ุฌููุน ูุญุงุฏุซุงุชู ูู ุตูุญุฉ "ูุญุงุฏุซุงุชู".',
  
  // ุงููุฒุงุฏุงุช
  'ูุฒุงุฏ|ูุฒุงุฏุงุช|auction': 'ุงููุฒุงุฏุงุช ูู ุณูู ุงูููู ุชุชูุญ ูู:\nโข ุงููุฒุงูุฏุฉ ุนูู ุงูููุชุฌุงุช\nโข ูุชุงุจุนุฉ ุงููุฒุงุฏุงุช ุงูููุชูุญุฉ\nโข ุงูุญุตูู ุนูู ุฃูุถู ุงูุฃุณุนุงุฑ\n\nุงุจุญุซ ุนู ุงูุฅุนูุงูุงุช ุงูุชู ุชุญุชูู ุนูู ุนูุงูุฉ "ูุฒุงุฏ" ูููุดุงุฑูุฉ.',
  
  // ุงูุชุณุฌูู ูุงูุญุณุงุจ
  'ุชุณุฌูู|ุญุณุงุจ|ุฏุฎูู|login|register': 'ููุชุณุฌูู ูู ุณูู ุงูููู:\n1. ุงุถุบุท ุนูู "ุชุณุฌูู" ูู ุงููุงุฆูุฉ\n2. ุฃุฏุฎู ุจุฑูุฏู ุงูุฅููุชุฑููู ููููุฉ ุงููุฑูุฑ\n3. ุฃููู ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ\n\nุฃู ููููู ุงุณุชุฎุฏุงู ุงูุชุณุฌูู ุงูุณุฑูุน ุนุจุฑ Google.',
  
  // ุงูุจุญุซ
  'ุจุญุซ|search|ุงุจุญุซ': 'ููุจุญุซ ุนู ุฅุนูุงู:\n1. ุงุณุชุฎุฏู ุดุฑูุท ุงูุจุญุซ ูู ุงูุฃุนูู\n2. ุฃู ุชุตูุญ ุงููุฆุงุช ุงููุฎุชููุฉ\n3. ุงุณุชุฎุฏู ุงูููุงุชุฑ ูุชุถููู ุงููุชุงุฆุฌ\n\nููููู ุฃูุถุงู ุงุณุชุฎุฏุงู ุงูุฎุฑูุทุฉ ููุจุญุซ ุญุณุจ ุงููููุน.',
  
  // ูุนูููุงุช ุงูุฅุนูุงู
  'ุตูุฑ|ุงุถุงูุฉ ุตูุฑ|ุฑูุน ุตูุฑ': 'ููููู ุฅุถุงูุฉ ุญุชู 8 ุตูุฑ ููู ุฅุนูุงู. ุชุฃูุฏ ูู:\nโข ุฌูุฏุฉ ุงูุตูุฑ ุนุงููุฉ\nโข ุงูุตูุฑ ูุงุถุญุฉ ูุชุธูุฑ ุงูููุชุฌ ุจุดูู ุฌูุฏ\nโข ุชููุน ุงูุฒูุงูุง',
  
  // ุงูุฃุณุนุงุฑ
  'ุณุนุฑ|ุงุณุนุงุฑ|price|prices': 'ูู ุณูู ุงูููู ููููู ุนุฑุถ ุงูุฃุณุนุงุฑ ุจู:\nโข ุงูุฑูุงู ุงููููู (ุฑ.ู)\nโข ุงูุฏููุงุฑ ุงูุฃูุฑููู ($)\n\nููููู ุฃูุถุงู ุงุฎุชูุงุฑ "ูุงุจู ููุชูุงูุถ" ุฅุฐุง ููุช ูุฑูุงู ูู ุงูุณุนุฑ.',
  
  // ุงููููุน
  'ูููุน|ุฎุฑูุทุฉ|location|map': 'ูุณุชุฎุฏู ุงูุฎุฑุงุฆุท ุงูุชูุงุนููุฉ ููุณุงุนุฏุชู ูู:\nโข ุชุญุฏูุฏ ูููุน ุงูููุชุฌ\nโข ุงูุจุญุซ ุญุณุจ ุงูููุทูุฉ\nโข ูุนุฑูุฉ ุงููุณุงูุฉ ูู ูููุนู\n\nููููู ุชูุนูู ุงููููุน ููุญุตูู ุนูู ูุชุงุฆุฌ ุฃุฏู.',
  
  // ุงูุฏุนู ูุงููุณุงุนุฏุฉ
  'ูุณุงุนุฏุฉ|ุฏุนู|help|support|ูุดููุฉ': 'ุฅุฐุง ููุช ุชูุงุฌู ุฃู ูุดููุฉ:\nโข ุชูุถู ุจุฒูุงุฑุฉ ุตูุญุฉ ุงููุณุงุนุฏุฉ: /help\nโข ุฃู ุชูุงุตู ูุนูุง: /contact\nโข ุฃู ุฑุงุณููุง ุนูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู\n\nูุญู ููุง ููุณุงุนุฏุชู! ๐',
  
  // ุดุฑูุท ุงูุงุณุชุฎุฏุงู
  'ุดุฑูุท|ุณูุงุณุฉ|privacy|terms': 'ููุงุทูุงุน ุนูู:\nโข ุดุฑูุท ุงูุงุณุชุฎุฏุงู: /terms\nโข ุณูุงุณุฉ ุงูุฎุตูุตูุฉ: /privacy\n\nูุญู ูุญุชุฑู ุฎุตูุตูุชู ููุญูู ุจูุงูุงุชู.',
};

// ุฏุงูุฉ ูุฅูุฌุงุฏ ุฃูุถู ุชุทุงุจู
function findBestMatch(message) {
  const lowerMessage = message.toLowerCase().trim();
  
  // ุงูุจุญุซ ุนู ุชุทุงุจู ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ
  for (const [pattern, response] of Object.entries(knowledgeBase)) {
    const patterns = pattern.split('|');
    // ุงุณุชุฎุฏุงู word boundaries ููุชุทุงุจู ุงูุฃุฏู
    if (patterns.some(p => {
      // ุฅูุดุงุก regex ูุน word boundaries ูุชุฌูุจ ุงูุชุทุงุจูุงุช ุงูุฎุงุทุฆุฉ
      const regex = new RegExp(`(^|\\s)${p.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}($|\\s|[ุ.ุ!])`, 'i');
      return regex.test(lowerMessage) || lowerMessage.includes(p);
    })) {
      return response;
    }
  }
  
  return null;
}

// ุฑุฏูุฏ ุนุงูุฉ
const greetings = ['ูุฑุญุจุง', 'ุงููุง', 'ุงูุณูุงู', 'ุตุจุงุญ', 'ูุณุงุก', 'ููุง', 'ููู', 'hello', 'hi'];
const thanks = ['ุดูุฑุง', 'ุดูุฑุงู', 'ูุนุทูู', 'thanks', 'thank you'];

export async function POST(request) {
  try {
    const { message } = await request.json();
    
    if (!message || typeof message !== 'string') {
      return NextResponse.json(
        { error: 'ุงูุฑุณุงูุฉ ูุทููุจุฉ' },
        { status: 400 }
      );
    }

    const trimmedMessage = message.trim();
    if (trimmedMessage.length === 0) {
      return NextResponse.json(
        { error: 'ุงูุฑุณุงูุฉ ูุงุฑุบุฉ' },
        { status: 400 }
      );
    }

    // ุชุญูู ูู ุงูุชุญูุฉ
    const lowerMessage = trimmedMessage.toLowerCase();
    if (greetings.some(g => lowerMessage.includes(g))) {
      return NextResponse.json({
        reply: 'ูุฑุญุจุงู ุจู ูู ุณูู ุงูููู! ๐พ๐ช\n\nุฃูุง ุงููุณุงุนุฏ ุงูุฐููุ ูููููู ูุณุงุนุฏุชู ูู:\nโข ูุนุฑูุฉ ุงููุฒูุฏ ุนู ุงููููุน\nโข ููููุฉ ุฅุถุงูุฉ ุฅุนูุงู\nโข ุงูุชูุงุตู ูุน ุงูุจุงุฆุนูู\nโข ุงูุจุญุซ ุนู ุงูููุชุฌุงุช\n\nููู ูููููู ูุณุงุนุฏุชูุ'
      });
    }

    // ุชุญูู ูู ุงูุดูุฑ
    if (thanks.some(t => lowerMessage.includes(t))) {
      return NextResponse.json({
        reply: 'ุงูุนูู! ๐ ุฃูุง ููุง ุฏุงุฆูุงู ููุณุงุนุฏุชู. ุฅุฐุง ูุงู ูุฏูู ุฃู ุงุณุชูุณุงุฑ ุขุฎุฑุ ูุง ุชุชุฑุฏุฏ ูู ุงูุณุคุงู.'
      });
    }

    // ุงูุจุญุซ ุนู ุฅุฌุงุจุฉ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ
    const answer = findBestMatch(trimmedMessage);
    
    if (answer) {
      return NextResponse.json({ reply: answer });
    }

    // ุฑุฏ ุงูุชุฑุงุถู ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุชุทุงุจู
    return NextResponse.json({
      reply: 'ุนุฐุฑุงูุ ูู ุฃููู ุณุคุงูู ุชูุงูุงู. ๐ค\n\nูููููู ูุณุงุนุฏุชู ูู:\nโข ูุนูููุงุช ุนู ุงููููุน ูุฎุฏูุงุชู\nโข ููููุฉ ุฅุถุงูุฉ ุฃู ุงูุจุญุซ ุนู ุฅุนูุงูุงุช\nโข ุงูุชูุงุตู ูุงููุญุงุฏุซุงุช\nโข ุงููุฒุงุฏุงุช ูุงููุฆุงุช\nโข ุงููุณุงุนุฏุฉ ูุงูุฏุนู\n\nุญุงูู ุฅุนุงุฏุฉ ุตูุงุบุฉ ุณุคุงูู ุฃู ุงุทุฑุญ ุณุคุงูุงู ูุญุฏุฏุงูุ ูุณุฃููู ุณุนูุฏุงู ุจูุณุงุนุฏุชู!'
    });

  } catch (error) {
    console.error('ุฎุทุฃ ูู API ุงููุณุงุนุฏ ุงูุฐูู:', error);
    return NextResponse.json(
      { error: 'ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุทูุจ' },
      { status: 500 }
    );
  }
}
