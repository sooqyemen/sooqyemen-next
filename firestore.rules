rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // Placeholder: implement admin check when ready
      return false;
    }
    
    // Categories collection - public read, admin write only
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Settings collection - public read, admin write only
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Referral links - owner or admin only
    match /referral_links/{linkId} {
      allow read: if isSignedIn() && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.ownerUid == request.auth.uid ||
                      isAdmin());
      allow create: if isSignedIn() && 
                       (request.resource.data.userId == request.auth.uid ||
                        request.resource.data.ownerUid == request.auth.uid);
      allow update: if isSignedIn() && 
                       (resource.data.userId == request.auth.uid ||
                        resource.data.ownerUid == request.auth.uid ||
                        isAdmin());
      allow delete: if isAdmin();
    }
    
    // Payout requests - owner or admin only
    match /payout_requests/{requestId} {
      allow read: if isSignedIn() && 
                     (resource.data.uid == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && 
                       request.resource.data.uid == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Referral events - create only (for tracking), no public read
    match /ref_events/{eventId} {
      allow read: if false;
      allow create: if true; // Allow anonymous tracking
      allow update, delete: if isAdmin();
    }
    
    // Site views - create only (for tracking), no public read
    match /site_views/{viewId} {
      allow read: if false;
      allow create: if true; // Allow anonymous tracking
      allow update, delete: if isAdmin();
    }
    
    // Listings collection
    match /listings/{listingId} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && 
                               (isOwner(resource.data.userId) || isAdmin());
      
      // Comments subcollection
      match /comments/{commentId} {
        allow read: if true; // Public read
        allow create: if isSignedIn();
        allow update, delete: if isSignedIn() && 
                                 (isOwner(resource.data.userId) || isAdmin());
      }
      
      // Bids subcollection
      match /bids/{bidId} {
        allow read: if true; // Public read
        allow create: if isSignedIn();
        allow update, delete: if isSignedIn() && 
                                 (isOwner(resource.data.userId) || isAdmin());
      }
    }
    
    // Chats collection
    match /chats/{chatId} {
      // Allow read if user is a participant
      allow read: if isSignedIn() && 
                     request.auth.uid in resource.data.participants;
      
      // Allow create/update if user is one of the participants
      allow create, update: if isSignedIn() && 
                               request.auth.uid in request.resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Allow read if user is a participant of the parent chat
        allow read: if isSignedIn() && 
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Allow create if:
        // 1. User is signed in
        // 2. User is a participant of the parent chat
        // 3. The 'from' field matches the authenticated user
        // 4. The 'text' field is present and is a string between 1-2000 characters
        // 5. createdAt is set (will be serverTimestamp, but we don't enforce timestamp type to avoid conflicts)
        allow create: if isSignedIn() && 
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
                         request.resource.data.from == request.auth.uid &&
                         request.resource.data.text is string &&
                         request.resource.data.text.size() >= 1 &&
                         request.resource.data.text.size() <= 2000 &&
                         request.resource.data.keys().hasAll(['from', 'text', 'createdAt']);
      }
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if true; // Public read for user profiles
      allow write: if isOwner(userId);
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
